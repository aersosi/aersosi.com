---
import BaseLayout from "@/components/layouts/BaseLayout.astro";
import Text from "@/components/elements/Text.astro";
import Wrapper from "@/components/containers/Wrapper.astro";
import Link from "@/components/elements/Link.astro";
import ProjectEntry from "@/components/entries/ProjectEntry.astro";
const { frontmatter } = Astro.props;
import { getCollection } from "astro:content";
import ExternalLink from "@/lib/icons/ExternalLink.astro";
import { stackGrid, stackGridPadding } from "@/lib/shared/abstracts";
import CarouselWrapper from "@/components/elements/CarouselWrapper.astro";

const allProjects = await getCollection("projects");
const relatedProjects = allProjects.filter((project) =>
  project.data.tags.some((tag) => frontmatter.tags.includes(tag)) &&
  project.data.viewerTitle !== frontmatter.viewerTitle
);
---

<BaseLayout
  pageTitle={frontmatter.pageTitle}
  pageDescription={frontmatter.pageDescription}
  article={true}
  publishDate={frontmatter.pubDate}
>
  <section>
    <Wrapper variant="standard">
      <div class:list={[...stackGrid, ...stackGridPadding]}>
        <div class="flex gap-8 flex-col">
            <Text tag="h1" isPrimary>
              {frontmatter.viewerTitle}
            </Text>
            <Text tag="p" variant="textBase">
              {frontmatter.pageDescription}
            </Text>

            <div class="grid gap-8">
              <div class="grid gap-2">
                <Text tag="h2">
                  Online
                </Text>

                {frontmatter.repo || frontmatter.demo ? (
                  <div class="flex gap-6">
                    {frontmatter.repo && (
                      <Link target="_blank"
                            href={frontmatter.repo.href}
                            aria-label={frontmatter.repo.ariaLabel}
                            size="base"
                            variant="primary"
                            data-a11ytip-bottom
                      >
                        {frontmatter.repo.name}
                        <ExternalLink size="base" class="-mt-0.5" />
                      </Link>
                    )}
                    {frontmatter.demo && (
                      <Link target="_blank"
                            href={frontmatter.demo.href}
                            aria-label={frontmatter.demo.ariaLabel}
                            size="base"
                            variant="primary"
                            data-a11ytip-bottom
                      >
                        {frontmatter.demo.name}
                        <ExternalLink size="base" class="-mt-0.5" />
                      </Link>
                    )}
                  </div>
                ) : (
                  frontmatter.noLinksText && (
                    <Text tag="p" variant="textBase">
                      {frontmatter.noLinksText}
                    </Text>
                  )
                )}
              </div>

              {frontmatter.company ? (
                <div class="grid gap-2">
                  <Text tag="h2">
                    Kunde
                  </Text>

                  <Text tag="p" variant="textBase">
                    {frontmatter.company.companyName}
                  </Text>
                </div>

                <div class="grid gap-2">
                  <Text tag="h2">
                    Aufgabe im Team ({frontmatter.company.teamSize} Pers.)
                  </Text>

                  <Text tag="p" variant="textBase" class="text-balance">
                    {frontmatter.myRole}
                  </Text>
                </div>
              ) : (
                <div class="grid gap-2">
                  <Text tag="h2">
                    Aufgabe
                  </Text>

                  <Text tag="p" variant="textBase" class="text-balance">
                    {frontmatter.myRole}
                  </Text>
                </div>
              )}
            </div>

        </div>
        <div class="lg:col-span-2">
          <CarouselWrapper images={frontmatter.images} />

          <Wrapper variant="prose">
            <slot />
          </Wrapper>
        </div>
      </div>
    </Wrapper>
  </section>
  {
    relatedProjects.length > 0 && (
      <section>
        <Wrapper variant="standard">
          <div class:list={[...stackGrid, ...stackGridPadding]} class="border-t">
            <Text tag="h2">
              Ã„hnliche Projekte
            </Text>
            <div class="flex flex-col gap-12 lg:col-span-2">
              {relatedProjects.slice(0, 3).map((project) => (
                <ProjectEntry project={project} />
              ))}
            </div>
          </div>
        </Wrapper>
      </section>
    )
  }
</BaseLayout>
